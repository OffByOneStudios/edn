```markdown
# EDN-0008: Phase 4 Windows/MSVC Bring-Up & Cross-Platform Parity Preservation

Status: OPEN  
Priority: High (re-establish Windows green without regressing Darwin)  
Owner: Unassigned  
Created: 2025-08-25

## Summary
Phase 4 parity, refactors, and debug info tasks are complete on macOS/Darwin (see EDN-0007). This issue tracks re-enabling and validating the Phase 4 feature set on Windows/MSVC (and MinGW if applicable) while ensuring **no regressions on Darwin** regarding:
- Zero-warning build under strict flags
- Debug info coverage (scopes, captured closures, struct & match binding member offsets)
- Coroutine minimal & suspend/final-suspend attributes / intrinsics
- Panic unwind (Itanium vs SEH) personality selection and cleanup path shape
- Conditional ShowVT fallback gating
- Pass pipeline & IR verification stability

All Windows changes must be validated on local Windows/MSVC builds and cross-checked on Darwin before merge (two-platform confirmation per task where relevant).

## Goals
1. Achieve full Phase 4 test suite pass on Windows.
2. Preserve zero warnings (treat new warnings as regressions) on both Windows (MSVC / clang-cl if used) and Darwin.
3. Confirm SEH-specific lowering (cleanuppad / catchswitch patterns if/when introduced) matches expectations and does not break existing Itanium tests.
4. Validate environment variable handling / `_putenv` vs `_putenv_s` shims: ensure tests compile and function with MSVC secure CRT while keeping portability.
5. Ensure debug info (PDB / CodeView) generates without blocking errors when EDN_ENABLE_DEBUG=1 (even if tests currently assert only structural IR metadata). No Darwin DI regressions.

## Task Breakdown

### A. Environment & Build Setup
- [ ] Add documented Windows build instructions (README Phase 4 Windows subsection or separate doc) including required LLVM version & vcpkg integration.
- [ ] Verify CMake toolchain selects correct MSVC runtime and no extraneous LLVM component duplication (mirrors Darwin link pruning).
- [ ] Enable `EDN_STRICT_WARNINGS` equivalent under MSVC (translate current Clang/GCC warning flags to `/W4` or `/permissive-` set) and confirm zero warnings.
- [ ] Add conditional warning flags mapping (MSVC vs Clang) in `CMakeLists.txt` without regressing Darwin flags.

### B. Exception Handling (SEH vs Itanium)
- [ ] Validate `edn::ir::exceptions::select_personality` chooses SEH personality on Windows targets; add Windows-specific personality test.
- [ ] Add regression test asserting no Itanium landingpad when SEH model selected, and that cleanup funclet (`cleanuppad` / `cleanupret`) appears where expected.
- [ ] Cross-check Darwin still emits Itanium landingpad form (re-run existing panic unwind tests) – no diff required.

### C. Coroutines
- [ ] Confirm coroutine attributes (`presplitcoroutine`) and intrinsics lower and link under MSVC/LLD or link.exe (some intrinsic availability differences possible). Adjust tests to allow platform-specific intrinsic naming if needed.
- [ ] Add Windows-specific coroutine smoke test if IR differences (naming / attribute spelling) require conditional assertions — otherwise reuse existing tests.

### D. Debug Info / PDB
- [ ] Run full suite with `EDN_ENABLE_DEBUG=1` and verify no LLVM assertions specific to PDB emission.
- [ ] Add optional test (skipped on Darwin) that loads generated object/bitcode and ensures DISubprogram / DILocalVariable counts meet minimum thresholds (structure only; no PDB parsing yet).
- [ ] Confirm struct & match binding DI offset tests pass (offset semantics should match DataLayout on Windows).

### E. Environment Variable Shims
- [ ] Audit tests using `_putenv` / `_putenv_s` for portability: introduce a tiny cross-platform helper (e.g., `tests/test_env.hpp`) that abstracts setting/unsetting env vars (POSIX `setenv/unsetenv`, Windows `_putenv/_putenv_s`).
- [ ] Replace direct `_putenv` / `_putenv_s` calls in tests with helper to avoid divergence and future warning noise.
- [ ] Ensure helper does not reintroduce warnings on Darwin (validate both platforms prior to merge).

### F. CI & Cross-Platform Guardrails
- [ ] Add (or update) CI matrix entries: macOS (clang), Windows (MSVC + optional clang-cl), ensuring Phase 4 tests run with `EDN_STRICT_WARNINGS=ON` and treat warnings as errors (`EDN_WARNINGS_AS_ERRORS=ON`).
- [ ] Integrate `scripts/di_grep_check.sh` or Windows PowerShell equivalent for a minimal DI presence check (skip gracefully if unavailable); failures block merge.
- [ ] Add coroutine & panic unwind tests to CI run list (ensure env vars set appropriately in job config).

### G. Pass Pipeline & Verification
- [ ] Ensure `EDN_ENABLE_PASSES=1` pipeline runs cleanly with verification on Windows (matching Darwin). Add failing IR capture on mismatch for debugging.
- [ ] Confirm no new invalid debug intrinsics or attribute mismatches post-pass (run llvm-verifier with debug enabled).

### H. Documentation & Tracking
- [ ] Update README (or new `docs/WINDOWS.md`) summarizing Windows re-enable steps, known differences (e.g., SEH personalities, potential coroutine intrinsic differences), and env var usage.
- [ ] Add note in README Phase 4 status: Windows validation in progress (link to this issue) until complete, then remove note when closed.
- [ ] Add CHANGES entry referencing EDN-0008 upon closure.

### I. Regression Safeguards (Darwin Preservation)
For each completed Windows task above, perform a Darwin rebuild & selective test run to confirm:
- [ ] Zero new warnings introduced (Clang, strict flags).
- [ ] No change in DWARF member offsets or match binding offset tests.
- [ ] Coroutine attribute & intrinsic test still passes unchanged.
- [ ] Panic unwind (Itanium) test output unchanged.
- [ ] ShowVT fallback gating test unchanged.
(Automate via simple script that diffs saved golden IR / metadata counts where feasible.)

### J. Stretch / Optional
- [ ] Investigate enabling minimal PDB parsing to assert presence of symbols (future tooling; out-of-scope if time constrained).
- [ ] Explore unified panic personality abstraction if Windows introduces new variations (defer if not immediately needed).

## Acceptance Criteria
All mandatory tasks (A–I) checked. Phase 4 test suite green on Windows + Darwin with zero warnings. Exception model selection & coroutine tests pass both platforms. Debug info tests (scopes, member & match binding offsets) pass identically. Environment helper replaces direct `_putenv` calls. CI matrix includes Windows. Documentation updated and no Darwin regressions.

## Cross-Issue References
- Depends on: EDN-0007 (macOS completion context)
- Closes gap left in EDN-0007 Part C (Windows validation)
- Related earlier issues: EDN-0002..0006 for historical refactors.

## Progress Log
- 2025-08-25: Issue created capturing Windows/MSVC parity & regression guard tasks post-Darwin Phase 4 completion.

```
