```markdown
# EDN-0007: Phase 4 Port Completion & Parity Follow-ups

Status: OPEN  
Priority: High (stabilize & polish after initial macOS Phase 4 green)  
Owner: Unassigned  
Created: 2025-08-22

## Summary
Phase 4 tests now pass on macOS (see closure of EDN-0002, 0003, 0005, 0006). This issue consolidates the remaining parity, polish, and cross‑platform tasks that were intentionally deferred to keep the port moving. Completing this list will fully retire residual monolithic logic, hardcoded fallbacks, and missing debug / test coverage.

## Remaining Work Breakdown

### A. Debug Info (migrated from EDN-0004)
- [ ] Extract remaining inline DI logic from `src/edn.cpp` into `ir/di.cpp` (types, locals, parameters, lexical blocks).
- [ ] Central `declare_local` helper (choose dbg.declare vs dbg.value) and replace ad‑hoc sites.
- [ ] Match bind DI (`dbg.value` for each bound field).
- [ ] Closure thunk + closure struct DI (DISubprogram + env param variable; mark artificial later).
- [ ] Add scope nesting / shadowing / struct member offset tests.
- [ ] Pseudo line mapping (simple monotonic counter) for lexical blocks & locals.

### B. Resolver & Orchestration Cleanup (from EDN-0005 / EDN-0003)
- [ ] Unify value resolution helpers (`ensureSlot`, `getVal`, `evalDefined`) into a single resolver utility or methods on `builder::State`.
- [ ] Optionally extract function definition parsing / creation into `function_builder` module.

### C. Windows & Cross-Platform Validation
- [ ] Run full Phase 4 suite on Windows (Itanium vs SEH personality selection sanity) and fix any SEH regressions.
- [ ] Verify `_putenv` shim is excluded / guarded correctly on Windows builds.

### D. JIT & Coroutine / Panic Paths
- [ ] Enable JIT smoke tests with `EDN_RUN_JIT=1` (add CI gating or local instruction) and ensure they pass.
- [ ] Add coroutine minimal + suspend/final-suspend IR regression tests (currently only smoke / golden IR).
- [ ] Add panic unwind path regression tests (Itanium & SEH) verifying landingpad / cleanuppad sequence.

### E. ABI / VTable Emission Polish
- [ ] Replace unconditional `%struct.ShowVT` fallback global with conditional emission triggered only during ABI golden test (env flag or explicit request) to avoid noise in unrelated modules.
- [ ] Add test ensuring fallback is not emitted when trait vtables are naturally generated.

### F. Pass / Verification Pipeline
- [ ] Add regression test toggling `EDN_ENABLE_PASSES=1` with a minimal pipeline to confirm no DI or EH regressions.
- [ ] Explicit test for `EDN_VERIFY_IR=1` path on representative modules (sums, EH, coroutines).

### G. Sum / Match Enhancements
- [ ] Standardize naming of payload related temporaries (currently `.fldN.raw` consistent; verify all ops) and update docs if needed.
- [ ] Add match binding offset test ensuring DataLayout offsets used in DI & IR agree.

### H. Documentation
- [ ] Author `docs/DEBUG_INFO.md` (was acceptance item of EDN-0004) summarizing DI strategy & mapping.
- [ ] Update `README.md` Phase 4 status section to reflect completed refactor & remaining follow-ups moved here.

### I. Quality Gates & Tooling
- [ ] Add a lightweight DWARF / IR pattern utility (optional) or scripted grep harness for debug metadata validation.
- [ ] Ensure zero new Clang warnings after DI extraction (treat as failure in CI script if possible).

## Acceptance Criteria
All unchecked tasks above completed; macOS & Windows Phase 4 suites (with optional JIT) green; DI tests cover scopes, shadowing, match binds, closure thunks; fallback ShowVT logic removed or gated; resolver unification merged; documentation updated.

## References
- Closed issues: EDN-0002 (sum ops repair), EDN-0003 (modularization), EDN-0004 (superseded content), EDN-0005 (residual modularization), EDN-0006 (LLVM cast assertion fix).
- Source: `src/edn.cpp`, `src/edn/ir/*`
- Tests: `tests/phase4_*`

## Changelog Linkage
Include a single consolidated changelog entry when this issue closes summarizing Phase 4 parity completion.

```