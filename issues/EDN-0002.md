# EDN-0002: Repair src/edn.cpp corruption and complete sum ops for Phase 4 on Darwin

Summary
- The file `src/edn.cpp` is corrupted by malformed insertions from a partial patch while implementing Phase 4 sum ops. The build is currently broken. After cleanup, implement `sum-new`/`sum-get`/`sum-is` to satisfy golden IR tests on macOS (Darwin, Itanium EH) without breaking Windows.

Affected area
- Core IR emitter: `src/edn.cpp`
- Phase 4 tests (golden IR for sum ops): `tests/phase4_*`, `edn/phase4/*`

Symptoms
- Build fails with syntax and undeclared identifier errors originating from `src/edn.cpp`.
- The file contains many lines starting with a literal `+` (patch markers), duplicated blocks (e.g., multiple `make-closure`/`call-closure` handlers), contaminated sections (sum/match code inside closure code), and a truncated end-of-file.

Environment
- macOS arm64 (Apple Silicon), Apple Clang/LLVM 18.x
- CMake + Ninja; single build dir `build`; vcpkg toolchain
- Exception handling: Itanium on Darwin, SEH on Windows

Context
- Darwin bring-up is documented in `design/ports/darwin/README.md`. LLVM AArch64 target and PIC are enabled on Darwin; LLVM RTTI is off to match LLVM.
- Recent fixes landed before the corruption:
  - SEH catchpad arg fix (added missing `i32 0`/`ti1`).
  - Switch initial branch uses `caseBlocks[0]`.
  - Match binds `tagMap` from `sum_variant_tag_[sname]` and correct GEPs on provided pointer.
  - Panic else-if reattached; `zext` op added.
  - DI: StructType bodies defined before DataLayout queries.

Root cause (likely)
- Partial/manual merge of sum ops (`sum-new`/`sum-get`/`sum-is`) introduced patch artifacts and duplicated/overlapping code blocks, breaking the large else-if dispatch chain and truncating the file tail.

Proposed fix
1) Repair `src/edn.cpp` structure
   - Remove all spurious leading `+` markers.
   - Deduplicate op handlers so each op appears exactly once in the main else-if chain.
   - Remove sum/match snippets accidentally inserted into unrelated handlers (e.g., inside `call-closure`).
   - Ensure braces and blocks are balanced; restore a single coherent dispatch chain.
   - Fix the truncated end-of-file by reconstructing the missing tail. If needed, consult the last known good version and reapply only the minimal intended deltas listed in Context.

2) Implement sum ops cleanly (align with golden IR expectations)
   - `sum-new`: store the tag at `.tag.addr` and write fields into `.payload.addr` using DataLayout for offsets. Use i8 GEP for byte addressing, then cast to field types before store. Apply stable IR names matching tests (e.g., `.tag.addr`, `.payload.addr`, `.fldN.raw`).
   - `sum-get`: load from `.payload.addr` using the correct field offset and typed load; bind to `%dst`.
   - `sum-is`: compare loaded tag to the expected variant tag to produce an `i1`.

3) Keep platform behavior stable
   - Preserve Itanium EH on Darwin and SEH on Windows. Do not change Windows behavior.
   - Ensure LLVM RTTI remains off and PIC stays on for Darwin library targets.

Tasks
- [ ] Clean patch artifacts and duplicates from `src/edn.cpp`; restore file tail.
- [ ] Reintroduce known-good fixes (SEH arg, switch, match, panic, zext, DI ordering) if lost during cleanup.
- [ ] Implement `sum-new`/`sum-get`/`sum-is` with DataLayout-based payload offsets and test-aligned naming.
- [ ] Build on macOS: `cmake --preset default` then `cmake --build build`.
- [ ] Run Phase 4 tests: `ctest --test-dir build -R "edn\\.phase4(\\.full)?$" --output-on-failure`.
- [ ] Sanity-check Windows build to ensure no regressions.

Acceptance criteria
- Build succeeds on macOS and Windows without new warnings.
- `edn.phase4` and `edn.phase4.full` pass, including golden IR for sum-new/sum-get/sum-is.
- No stray `+` lines, no duplicate op handlers, and `src/edn.cpp` ends properly.

Risks/notes
- Large chained else-if is sensitive to brace and insertion errors. Validate with an editor brace-matching pass and a quick-format pass.
- Prefer small, verifiable commits: (1) cleanup only, (2) reintroduce fixes, (3) sum ops.

References
- `design/ports/darwin/README.md`
- `tests/phase4_*.cpp`, `edn/phase4/*`
- `include/edn/type_check.inl` for validation logic
- `src/edn.cpp` for IR emission
