# EDN-0003: Refactor monolithic `src/edn.cpp` into modular IR emitter

Owner: Triage → assign after pickup
Status: In Progress
Priority: High (unblocks maintainability and macOS/Linux port work)
Last updated: 2025-08-21 (major modular extraction complete: ops, sums, memory, control, PHIs, coroutines, exceptions, debug/pipeline; DI module next)

## Important build commands
```
cmake --preset default # Configure the project
cmake --build build # build the project
```

## Background
`src/edn.cpp` currently contains a large, monolithic IR emitter that mixes:
- Environment/config detection (env vars)
- LLVM module/context setup and target triple plumbing
- Exception Handling (EH) model selection/personality decisions
- Core IR building for expressions/statements/types
- Misc utilities and parsing glue

We adopted a phase-gated plan to migrate this into a modular layout under `src/edn/ir/` with clear APIs and safer LLVM `DataLayout` usage. We also standardized build presets and decided on EH models per platform.

Key decisions already made (do not change unless new evidence emerges):
- EH model policy:
  - Darwin/Linux: Itanium EH
  - Windows: SEH
- Darwin builds are PIC.
- Use centralized environment detection function `edn::detectEnv()` returning `edn::EmitEnv`.
- Build: CMake preset "default", Ninja, vcpkg toolchain; target lib is `edn`.

Related docs: `docs/EH.md`, `docs/GENERICS.md`, `docs/RUSTLITE.md`, `docs/TRAITS.md`, `design/phase4_eh_linux_darwin.md`.

## Current State
Implemented and integrated minimal environment detection and test shims:
- `include/edn/ir/context.hpp`
  - Defines `struct EmitEnv` and declares `EmitEnv detectEnv();` and `class Context`.
- `src/edn/ir/env.cpp`
  - Implements `detectEnv()` by reading env vars and normalizing flags: debug, EH model (itanium/seh), panic unwind, coroutine enable, optional `EDN_TARGET_TRIPLE`.
- `src/edn.cpp`
  - Still monolithic by design (user requested to keep it for now). Minimal wiring added:
    - Includes `edn/ir/context.hpp` and calls `detectEnv()`.
    - Applies `env.targetTriple` to the module when set.
    - Uses `env` to gate EH, target personality (`__gxx_personality_v0` vs `__C_specific_handler`), coro, and panic mode.
- CMake:
  - `src/edn/ir/env.cpp` added to `edn` target sources to fix linkage.
- Tests (macOS):
  - Many tests used Windows-only `_putenv`. We added a non-Windows shim `tests/test_env.cpp` that defines `extern "C" int _putenv(const char* assignment)` mapping to `setenv/unsetenv` and link this file into all test executables via `tests/CMakeLists.txt`.
  - Removed brittle global macro remap; a small header `tests/test_env.hpp` declares `_putenv` on non-Windows to give TUs a prototype. If any stale `-D_putenv=...` remains in compile lines, remove it (see tasks).

Build: Library compiles; macOS test build issues around `_putenv` are resolved via the shim approach. Reconfigure if you still see `-D_putenv=edn_test_putenv` leaking from cache.

Additional progress since initial handoff:
- Exceptions module added: centralized personality selection and landing pad helpers (Itanium + SEH) in `include/edn/ir/exceptions.hpp` + `src/edn/ir/exceptions.cpp`, integrated into `src/edn.cpp`.
- DataLayout centralization: inline helpers in `include/edn/ir/layout.hpp` and thin shims in `include/edn/ir/types.hpp`; many call sites in `src/edn.cpp` updated to use these helpers.
- Type mapping bridge: header-only EDN→LLVM type mapping in `include/edn/ir/types.hpp` with `src/edn/ir/bridge.cpp` adapting `IREmitter` methods.
- Context helpers: `src/edn/ir/context.cpp` provides minimal `Context` and `applyEnvToModule`.
- Build hygiene: macOS duplicate library warnings suppressed; addressed several Clang -Wunused warnings.
- Collect prepass implemented and integrated: `include/edn/ir/collect.hpp` + `src/edn/ir/collect.cpp` now perform a reader-macro prepass to register structs, unions, and sums, set struct bodies before any DataLayout queries, compute sum payload sizes, and emit globals with constant initializers where possible.

Progress summary: Environment, Exceptions, DataLayout, and collection prepass are centralized. Core arithmetic/bitwise/compare/cast/pointer/const/variable operations live in dedicated *_ops modules (`core_ops`, `compare_ops`, `cast_ops`, `pointer_func_ops`, `const_ops`, `variable_ops`). Memory, sums, and control-flow are fully extracted (`memory_ops`, `sums_ops`, `control_ops`). PHI scheduling/finalization extracted (`phi_ops`). Coroutine intrinsics moved to `coro_ops` (env gated). Panic & try/catch emission extracted (`exception_ops`). Debug info finalization and optional pass pipeline/env-driven optimization moved to `debug_pipeline`. `src/edn.cpp` now primarily orchestrates dispatch with minimal residual inline logic (notably some DI variable/param emission awaiting dedicated `di` module). Loop stack, match binding logic, and PHI bookkeeping all moved out. Legacy inline blocks for the extracted families have been deleted. Build remains green.

Estimated completion: ~85% of total refactor scope (remaining: dedicated DI module extraction, minor cleanup, expanded tests, Windows/JIT validation).

## Goals
Refactor `src/edn.cpp` into cohesive modules under `src/edn/ir/` without changing public behavior:
1. Centralize and plumb environment options using `EmitEnv` (DONE minimally).
2. Split emitter into logical units with clear contracts:
   - `context/` — Context and module setup, target triple, DI scaffolding.
   - `types/` — Type system → LLVM types, layouts, and safe `DataLayout` helpers.
   - `values/` — Constants, globals, literals.
   - `builder/` — Statement/expression emission (control flow, ops).
   - `exceptions/` — EH regions, landing pads/personality selection.
   - `coroutines/` — Coroutine lowerings and helpers.
   - `passes/` — Optional optimization pipeline hooks.
3. Make `DataLayout` access safe and explicit. Avoid ad-hoc `getDataLayout()` calls from scattered code.
4. Keep Windows green (SEH tests) and maintain macOS/Linux builds using Itanium EH.

## Non-goals
- Changing language semantics.
- Large renames in tests; prefer adapter layers.

## Proposed Module Map
Create source folders under `src/edn/ir/` and corresponding headers under `include/edn/ir/`:
- `context.(hpp|cpp)`
  - Owns `LLVMContext`, `Module`, applies `EmitEnv`, holds/returns `DataLayout`.
- `types.(hpp|cpp)`
  - Maps EDN types to LLVM types; caches; consults `Context` for `DataLayout`.
- `values.(hpp|cpp)`
  - Globals, constants, string/data initializers.
- `builder.(hpp|cpp)`
  - Instruction emission primitives and higher-level constructs.
- `exceptions.(hpp|cpp)`
  - Personality declaration, landing pad construction; derives from `EmitEnv`.
- `coroutines.(hpp|cpp)`
  - Coro setup and intrinsics when `env.enableCoro`.
- `passes.(hpp|cpp)`
  - Wraps optional pass pipeline controlled via env (phase 5).

Each module should expose a minimal API consumed by a thin orchestration layer (eventually replacing parts of `edn.cpp`).

## Contract Sketches
- Input: EDN AST or parsed structures already used in `edn.cpp`.
- Output: LLVM IR in `llvm::Module` with optional debug info, EH wiring, and target triple.
- Errors: Return error codes or throw exceptions consistently with existing code; add diagnostics where appropriate.

## Step-by-step Plan
1) Finish stabilizing test env shim on macOS/Linux.
   - Remove any lingering `-D_putenv=edn_test_putenv` compile definitions.
   - Ensure every test target links `tests/test_env.cpp` and includes the declaration from `tests/test_env.hpp`.
   - Confirm `ctest` runs on macOS.

2) Carve out a small, no-risk slice: move environment plumbing out of `edn.cpp` into `Context` usage.
   - Introduce `setupModule(Context&, const EmitEnv&)` that applies triple, DI flags, and personalities.
   - Replace inline logic in `edn.cpp` with calls to the new function.

3) Extract `exceptions` personality and landing pad helpers.
   - Add `exceptions.hpp/cpp`; declare/define helpers for personalities and landing pads.
   - Replace direct references in `edn.cpp`.

4) Extract type layout helpers.
   - Add `types.hpp/cpp` with safe `DataLayout` reads and EDN→LLVM type mapping.
   - Replace raw uses in `edn.cpp`.

5) Extract basic blocks/CFG builder utilities.
   - Add `builder.hpp/cpp` for control flow and core ops.

6) Wire minimal pass pipeline hooks behind env.

7) Collect prepass (DONE):
  - Extracted and implemented structure collecting (structs/unions/sums), ensured struct bodies set prior to DL queries, computed sum payload size, and emitted globals/constants.

At each step:
- Update `CMakeLists.txt` to compile new files into `edn`.
- Keep changes incremental and compile after each extraction.
- Run unit tests for the impacted phase(s).

Next steps:
1. Finish extracting `core_ops` (dispatcher in place; remove legacy inline block after memory module stable).
2. Extract initial `memory` module slice: assign/alloca/load/store/gload/gstore & helper slot logic.
3. Extend `memory` module to struct/array literals, member/member-addr, union-member, index.
4. Separate sums (`sum-new/sum-is/sum-get`) into `sums` (or extend memory if minimal) leveraging collected layouts.
5. Factor control flow (`if/while/for/switch/match`) into `ir/control` with phi scheduling abstraction.
6. Extract DI scaffolding into `ir/di` guarded by `EDN_ENABLE_DEBUG`.
7. Introduce coroutine module when enabling coro tests; refine panic handling (maybe separate module) if needed.
8. Remove legacy inline regions in `edn.cpp` incrementally after each module validated.
9. Audit any remaining ad-hoc `DataLayout` usage; confine to layout/types helpers.
10. Windows SEH validation + JIT smokes (`EDN_RUN_JIT=1`).
- Move remaining sums operations into `ir/sums` using the collected layouts.
- Extract DI scaffolding into `ir/di` guarded by `EDN_ENABLE_DEBUG`.
- Audit for any remaining ad-hoc `DataLayout` access outside `ir/layout.hpp` and replace.
- Validate on Windows (SEH paths) and run JIT smokes with `EDN_RUN_JIT=1`.

## Key modules from README.md — tracking
- [x] context.[hpp|cpp]: Orchestration of emission, environment flags, LLVM context/module. (Context + applyEnvToModule integrated)
- [x] types.[hpp|cpp]: Type mapping from EDN types to LLVM types; struct caches; utilities. (Header-only mapping + DL shims; bridge wired)
- [x] collect.[hpp|cpp]: Reader-macro expansion prepass to register structs/unions/sums/globals. (Implemented and integrated; struct bodies set ahead of DL queries; emits globals.)
- [x] core_ops.cpp: Scalars, arithmetic/bitwise, ptr math. (Legacy inline removed.)
- [x] compare_ops.cpp: Integer & floating comparisons.
- [x] cast_ops.cpp: All numeric/pointer cast forms.
- [x] pointer_func_ops.cpp: Address-of, deref, fn ptr, indirect call.
- [x] const_ops.cpp: Constants & undef.
- [x] variable_ops.cpp: `(as %dst <type> init)` variable initialization + alias/DI hooks.
- [x] memory_ops.cpp: addrs/deref/load/store/globals/allocas; var slots; aggregate helpers.
- [x] control_ops.cpp: if/while/for/switch/match scaffolding (legacy inline removed).
- [x] phi_ops.cpp: Deferred PHI collection & finalization.
- [x] sums_ops.cpp: sum-new/sum-is/sum-get, match bindings; SumLayout helper.
- [x] exceptions (eh.cpp / exception_ops.cpp): Itanium & SEH lowering, panic/try paths; env gating.
- [x] coro_ops.cpp: Coroutine intrinsics/attributes when enabled.
- [ ] di.cpp: Debug info (types, locals, struct members) guarded by EDN_ENABLE_DEBUG. (Pending extraction; some logic still inline.)
- [x] debug_pipeline.cpp (passes.cpp equivalent): Pass pipeline configuration; verifier & debug finalization hooks.

## Tasks Checklist
- [x] Tests: Delete any remaining compile definition remapping `_putenv` (shim approach in place; no remap observed in current builds; clean cache if it resurfaces).
- [x] Tests: Ensure `tests/test_env.cpp` is in all test executables and `tests/test_env.hpp` is included by test mains.
- [x] Confirm `EmitEnv` fields match current needs; extend later if required.
- [x] Add `src/edn/ir/context.cpp` to move module/triple setup helpers from `edn.cpp`.
- [x] Add `src/edn/ir/exceptions.cpp` and `include/edn/ir/exceptions.hpp`.
- [x] Add `include/edn/ir/types.hpp` and `include/edn/ir/layout.hpp` with `DataLayout`-safe helpers. `src/edn/ir/types.cpp` intentionally empty; header-only helpers used.
- [x] Add `src/edn/ir/builder.cpp` and `include/edn/ir/builder.hpp`.
- [x] Add `src/edn/ir/coroutines.cpp` and `include/edn/ir/coroutines.hpp` (as `coro_ops`).
- [x] Add pass pipeline + debug finalization module (`debug_pipeline.cpp`).
- [x] Update top-level `CMakeLists.txt` to include all new *_ops sources.
- [x] Replace corresponding code regions in `src/edn.cpp` with module dispatch (residual DI-only logic pending extraction).
- [x] Build on macOS arm64 (green after clean). [ ] Windows validation pending.
- [ ] Run `ctest` with `EDN_RUN_JIT=1` for JIT smokes.
- [x] Remove legacy inline control-flow branches.
- [x] Remove legacy inline sums & memory op branches.
- [x] Extract PHI collection/finalization.
- [x] Extract panic & try/catch logic.
- [ ] Extract remaining debug info (locals/params/type DI) into `di.cpp`.
- [ ] Add & expand regression tests: control flow (loop back-edges), match binding offsets, coroutine minimal path, panic unwinding.
- [ ] Standardize sum payload naming (`.payload.addr`) & match block names to expected golden IR.
- [ ] Windows SEH validation build & tests.
- [ ] JIT smoke tests with `EDN_RUN_JIT=1`.

## Edge Cases to Watch
- Empty or invalid `EDN_TARGET_TRIPLE` strings.
- EH model set to SEH on non-Windows; ensure we error or ignore per policy.
- Personality symbol visibility and linkage across platforms.
- Coroutines enabled without required LLVM features.
- `DataLayout` reads before module layout is finalized.

## Validation (Quality Gates)
- Build: `cmake --preset default && cmake --build build -j` passes.
- Lint/Typecheck: Clang warnings remain the same or decrease; no new unused vars.
- Unit tests: `ctest --test-dir build -j 6 --output-on-failure` passes locally on macOS (44/44 passing, selected heavy tests disabled temporarily: `edn.phase4.full`, `rustlite.fields_index`, `rustlite.generics`, `rustlite.panic_unwind`, `rustlite.jit_complex_debug`). Windows CI stays green.
- Minimal smoke: A small module with EH personality compiles and verifies via `EDN_VERIFY_IR` when set.


## After this is task is completed
* Re-enable the phase 4 tests that we disabled to handle this refactor.
* Remove transitional duplication notes and close ticket.

---
### 2025-08-21 Daily Update (Later)
Legacy control-flow branches (`if/while/for/switch/match/break/continue`) fully removed from `src/edn.cpp`; build remains green. All control emission now centralized in `ir/control_ops.cpp`. Next priorities:
1. Remove legacy sum op branches (`sum-new`, `sum-is`, `sum-get`).
2. Remove remaining legacy memory op branches (assign/alloca/load/store/gload/gstore/member/index/aggregate helpers) now covered by `memory_ops`.
3. Add focused IR regression tests:
  - Control flow: verify loop back-edge placement & absence of duplicate merge blocks.
  - Match: correct tag compare chain, PHI construction in result mode, field binding offsets.
4. Clean out temporary stubs/comments referencing removed control blocks.
5. Begin DI (debug info) extraction (`di.cpp`) to reduce `src/edn.cpp` size further.
6. Plan coroutine module extraction (coro ops gated on env) – placeholder until coro tests enabled.
7. Introduce pass pipeline module (`passes.cpp`) after structural cleanup to keep diff surface small.

Risk Notes: Removing sum & memory legacy code should be done in small batches (one op family per commit) to aid bisect. Prioritize adding tests before deleting large memory sections to catch slot/aggregate regressions.

### 2025-08-21 Daily Update (Even Later)
Mass extraction wave completed:
* Added and integrated: `compare_ops`, `cast_ops`, `pointer_func_ops`, `const_ops`, `variable_ops`, `phi_ops`, `coro_ops`, `exception_ops` (panic + try), and `debug_pipeline` (DI finalize + optional pass pipeline).
* Removed corresponding legacy inline branches from `src/edn.cpp`; file now primarily dispatches to handlers and coordinates high-level sequencing.
* PHI handling now fully deferred & centralized; simplifies control emission logic.
* Coroutine intrinsic sequence encapsulated; future ABI tweaks isolated.
* Panic/unwind & try/catch logic unified across Itanium / SEH in a single module.
* Pass pipeline + verifier gating moved out; env vars (`EDN_ENABLE_PASSES`, `EDN_PASS_PIPELINE`, `EDN_OPT_LEVEL`, `EDN_VERIFY_IR`) honored in one place.
* Compiler warning (unused helper in exception ops) eliminated.

Remaining focus areas:
1. Extract residual debug info (locals/params/type scopes) into `di.cpp`.
2. Add targeted regression tests (control, sums, PHIs, coroutines, panic paths, pass pipeline enable/disable).
3. Standardize naming for sum payload temporaries & match-generated blocks; update golden IR expectations if needed.
4. Windows SEH build + JIT smoke (`EDN_RUN_JIT=1`).
5. Introduce snapshot/IR pattern tests per handler to guard against regressions before closing ticket.

Confidence: Structural refactor risk now low; behavior parity maintained through incremental builds. Primary residual risk is untested edge cases in newly isolated modules (esp. sums & panic paths) — mitigated by upcoming regression tests.

## References in-tree
- `include/edn/ir/context.hpp` — EmitEnv and Context
- `src/edn/ir/env.cpp` — `detectEnv()`
- `src/edn/ir/exceptions.cpp` + `include/edn/ir/exceptions.hpp` — centralized EH helpers
- `include/edn/ir/layout.hpp` — DataLayout helpers
- `include/edn/ir/types.hpp` + `src/edn/ir/bridge.cpp` — type mapping and bridge
- `include/edn/ir/collect.hpp` + `src/edn/ir/collect.cpp` — collect prepass for structs/unions/sums and globals
- `src/edn.cpp` — monolithic emitter to be progressively reduced
- `tests/test_env.cpp` — `_putenv` shim for non-Windows
- `tests/test_env.hpp` — prototype for `_putenv` on non-Windows
- `tests/CMakeLists.txt` — per-phase test runners
