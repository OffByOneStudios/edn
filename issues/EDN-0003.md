# EDN-0003: Refactor monolithic `src/edn.cpp` into modular IR emitter

Owner: Triage → assign after pickup
Status: In Progress
Priority: High (unblocks maintainability and macOS/Linux port work)
Last updated: 2025-08-21

## Important build commands
```
cmake --preset default # Configure the project
cmake --build build # build the project
```

## Background
`src/edn.cpp` currently contains a large, monolithic IR emitter that mixes:
- Environment/config detection (env vars)
- LLVM module/context setup and target triple plumbing
- Exception Handling (EH) model selection/personality decisions
- Core IR building for expressions/statements/types
- Misc utilities and parsing glue

We adopted a phase-gated plan to migrate this into a modular layout under `src/edn/ir/` with clear APIs and safer LLVM `DataLayout` usage. We also standardized build presets and decided on EH models per platform.

Key decisions already made (do not change unless new evidence emerges):
- EH model policy:
  - Darwin/Linux: Itanium EH
  - Windows: SEH
- Darwin builds are PIC.
- Use centralized environment detection function `edn::detectEnv()` returning `edn::EmitEnv`.
- Build: CMake preset "default", Ninja, vcpkg toolchain; target lib is `edn`.

Related docs: `docs/EH.md`, `docs/GENERICS.md`, `docs/RUSTLITE.md`, `docs/TRAITS.md`, `design/phase4_eh_linux_darwin.md`.

## Current State
Implemented and integrated minimal environment detection and test shims:
- `include/edn/ir/context.hpp`
  - Defines `struct EmitEnv` and declares `EmitEnv detectEnv();` and `class Context`.
- `src/edn/ir/env.cpp`
  - Implements `detectEnv()` by reading env vars and normalizing flags: debug, EH model (itanium/seh), panic unwind, coroutine enable, optional `EDN_TARGET_TRIPLE`.
- `src/edn.cpp`
  - Still monolithic by design (user requested to keep it for now). Minimal wiring added:
    - Includes `edn/ir/context.hpp` and calls `detectEnv()`.
    - Applies `env.targetTriple` to the module when set.
    - Uses `env` to gate EH, target personality (`__gxx_personality_v0` vs `__C_specific_handler`), coro, and panic mode.
- CMake:
  - `src/edn/ir/env.cpp` added to `edn` target sources to fix linkage.
- Tests (macOS):
  - Many tests used Windows-only `_putenv`. We added a non-Windows shim `tests/test_env.cpp` that defines `extern "C" int _putenv(const char* assignment)` mapping to `setenv/unsetenv` and link this file into all test executables via `tests/CMakeLists.txt`.
  - Removed brittle global macro remap; a small header `tests/test_env.hpp` declares `_putenv` on non-Windows to give TUs a prototype. If any stale `-D_putenv=...` remains in compile lines, remove it (see tasks).

Build: Library compiles; macOS test build issues around `_putenv` are resolved via the shim approach. Reconfigure if you still see `-D_putenv=edn_test_putenv` leaking from cache.

Additional progress since initial handoff:
- Exceptions module added: centralized personality selection and landing pad helpers (Itanium + SEH) in `include/edn/ir/exceptions.hpp` + `src/edn/ir/exceptions.cpp`, integrated into `src/edn.cpp`.
- DataLayout centralization: inline helpers in `include/edn/ir/layout.hpp` and thin shims in `include/edn/ir/types.hpp`; many call sites in `src/edn.cpp` updated to use these helpers.
- Type mapping bridge: header-only EDN→LLVM type mapping in `include/edn/ir/types.hpp` with `src/edn/ir/bridge.cpp` adapting `IREmitter` methods.
- Context helpers: `src/edn/ir/context.cpp` provides minimal `Context` and `applyEnvToModule`.
- Build hygiene: macOS duplicate library warnings suppressed; addressed several Clang -Wunused warnings.

Progress summary: Environment, Exceptions, and the majority of DataLayout usage are centralized and integrated; build is green on macOS after a clean.

Estimated completion: ~45% of total refactor scope through phase 4.

## Goals
Refactor `src/edn.cpp` into cohesive modules under `src/edn/ir/` without changing public behavior:
1. Centralize and plumb environment options using `EmitEnv` (DONE minimally).
2. Split emitter into logical units with clear contracts:
   - `context/` — Context and module setup, target triple, DI scaffolding.
   - `types/` — Type system → LLVM types, layouts, and safe `DataLayout` helpers.
   - `values/` — Constants, globals, literals.
   - `builder/` — Statement/expression emission (control flow, ops).
   - `exceptions/` — EH regions, landing pads/personality selection.
   - `coroutines/` — Coroutine lowerings and helpers.
   - `passes/` — Optional optimization pipeline hooks.
3. Make `DataLayout` access safe and explicit. Avoid ad-hoc `getDataLayout()` calls from scattered code.
4. Keep Windows green (SEH tests) and maintain macOS/Linux builds using Itanium EH.

## Non-goals
- Changing language semantics.
- Large renames in tests; prefer adapter layers.

## Proposed Module Map
Create source folders under `src/edn/ir/` and corresponding headers under `include/edn/ir/`:
- `context.(hpp|cpp)`
  - Owns `LLVMContext`, `Module`, applies `EmitEnv`, holds/returns `DataLayout`.
- `types.(hpp|cpp)`
  - Maps EDN types to LLVM types; caches; consults `Context` for `DataLayout`.
- `values.(hpp|cpp)`
  - Globals, constants, string/data initializers.
- `builder.(hpp|cpp)`
  - Instruction emission primitives and higher-level constructs.
- `exceptions.(hpp|cpp)`
  - Personality declaration, landing pad construction; derives from `EmitEnv`.
- `coroutines.(hpp|cpp)`
  - Coro setup and intrinsics when `env.enableCoro`.
- `passes.(hpp|cpp)`
  - Wraps optional pass pipeline controlled via env (phase 5).

Each module should expose a minimal API consumed by a thin orchestration layer (eventually replacing parts of `edn.cpp`).

## Contract Sketches
- Input: EDN AST or parsed structures already used in `edn.cpp`.
- Output: LLVM IR in `llvm::Module` with optional debug info, EH wiring, and target triple.
- Errors: Return error codes or throw exceptions consistently with existing code; add diagnostics where appropriate.

## Step-by-step Plan
1) Finish stabilizing test env shim on macOS/Linux.
   - Remove any lingering `-D_putenv=edn_test_putenv` compile definitions.
   - Ensure every test target links `tests/test_env.cpp` and includes the declaration from `tests/test_env.hpp`.
   - Confirm `ctest` runs on macOS.

2) Carve out a small, no-risk slice: move environment plumbing out of `edn.cpp` into `Context` usage.
   - Introduce `setupModule(Context&, const EmitEnv&)` that applies triple, DI flags, and personalities.
   - Replace inline logic in `edn.cpp` with calls to the new function.

3) Extract `exceptions` personality and landing pad helpers.
   - Add `exceptions.hpp/cpp`; declare/define helpers for personalities and landing pads.
   - Replace direct references in `edn.cpp`.

4) Extract type layout helpers.
   - Add `types.hpp/cpp` with safe `DataLayout` reads and EDN→LLVM type mapping.
   - Replace raw uses in `edn.cpp`.

5) Extract basic blocks/CFG builder utilities.
   - Add `builder.hpp/cpp` for control flow and core ops.

6) Wire minimal pass pipeline hooks behind env.

At each step:
- Update `CMakeLists.txt` to compile new files into `edn`.
- Keep changes incremental and compile after each extraction.
- Run unit tests for the impacted phase(s).

Next steps:
- Extract a small `values` module (globals/constants) and replace those paths in `src/edn.cpp`.
- Introduce a minimal `builder` module for basic blocks/CFG utilities and core ops; start swapping call sites.
- Audit for any remaining ad-hoc `DataLayout` access outside `ir/layout.hpp` and replace.
- Validate on Windows (SEH paths) and run JIT smokes with `EDN_RUN_JIT=1`.

## Tasks Checklist
- [x] Tests: Delete any remaining compile definition remapping `_putenv` (shim approach in place; no remap observed in current builds; clean cache if it resurfaces).
- [x] Tests: Ensure `tests/test_env.cpp` is in all test executables and `tests/test_env.hpp` is included by test mains.
- [x] Confirm `EmitEnv` fields match current needs; extend later if required.
- [x] Add `src/edn/ir/context.cpp` to move module/triple setup helpers from `edn.cpp`.
- [x] Add `src/edn/ir/exceptions.cpp` and `include/edn/ir/exceptions.hpp`.
- [x] Add `include/edn/ir/types.hpp` and `include/edn/ir/layout.hpp` with `DataLayout`-safe helpers. `src/edn/ir/types.cpp` intentionally empty; header-only helpers used.
- [ ] Add `src/edn/ir/builder.cpp` and `include/edn/ir/builder.hpp`.
- [ ] Add `src/edn/ir/coroutines.cpp` and `include/edn/ir/coroutines.hpp` when enabling coro tests.
- [x] Update top-level `CMakeLists.txt` to include new sources and headers in `include/edn/ir/`.
- [ ] Replace the corresponding code regions in `src/edn.cpp` with calls into the modules (in progress; DL sites largely migrated; values/builder still inline).
- [x] Build on macOS arm64 (green after clean). [ ] Windows validation pending.
- [ ] Run `ctest` with `EDN_RUN_JIT=1` for JIT smokes.

## Edge Cases to Watch
- Empty or invalid `EDN_TARGET_TRIPLE` strings.
- EH model set to SEH on non-Windows; ensure we error or ignore per policy.
- Personality symbol visibility and linkage across platforms.
- Coroutines enabled without required LLVM features.
- `DataLayout` reads before module layout is finalized.

## Validation (Quality Gates)
- Build: `cmake --preset default && cmake --build build -j` passes.
- Lint/Typecheck: Clang warnings remain the same or decrease; no new unused vars.
- Unit tests: `ctest --test-dir build -j 6 --output-on-failure` passes locally on macOS; Windows CI stays green.
- Minimal smoke: A small module with EH personality compiles and verifies via `EDN_VERIFY_IR` when set.

## References in-tree
- `include/edn/ir/context.hpp` — EmitEnv and Context
- `src/edn/ir/env.cpp` — `detectEnv()`
- `src/edn/ir/exceptions.cpp` + `include/edn/ir/exceptions.hpp` — centralized EH helpers
- `include/edn/ir/layout.hpp` — DataLayout helpers
- `include/edn/ir/types.hpp` + `src/edn/ir/bridge.cpp` — type mapping and bridge
- `src/edn.cpp` — monolithic emitter to be progressively reduced
- `tests/test_env.cpp` — `_putenv` shim for non-Windows
- `tests/test_env.hpp` — prototype for `_putenv` on non-Windows
- `tests/CMakeLists.txt` — per-phase test runners
