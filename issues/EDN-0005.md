# EDN-0005: Further Modularization of `edn.cpp`

## Summary
`src/edn.cpp` still contains several residual inline emission paths and utility lambdas that should be extracted to dedicated IR operation modules or helpers. This issue tracks the staged cleanup & extraction work to continue shrinking the orchestration file and improve testability.

## Goals
- Remove obsolete legacy emission branches now superseded by modular `ir/*_ops.cpp` handlers.
- Introduce new focused modules for remaining concerns (calls, returns, block wrapper, value resolution) in later steps.
- Keep each step small and test after every extraction.

## Current Residual Responsibilities in `edn.cpp`
1. Function definition parsing & creation (name/ret/params/vararg/external, attributes, personalities).
2. Inline emission dispatcher (lambda `emit_list`) still handling:
   - Direct calls + forward decl header scan + EH invoke emission.
   - Varargs helper forms (`va-start`, `va-arg`, `va-end`).
   - Return handling (slot-backed locals, default returns).
   - Simple `(block :body [...])` wrapper.
   - Phi finalization trigger.
3. Utility lambdas: `ensureSlot`, `getVal`, `evalDefined`.
4. EH / coroutine integration plumbing (personality stacks & counters) interwoven with call emission.
5. Redundant legacy branches for operations already modularized (float arith, compare, cast, bitwise, etc.).

## Planned Staged Work
| Stage | Description | Risk | Status | Notes |
|-------|-------------|------|--------|-------|
| 1 | Delete obsolete legacy branches (fadd/fsub/fmul/fdiv block & commented legacy compare/cast/bitwise placeholders) | Low | Done | Removed inline branches now covered by *_ops modules. |
| 2 | Add `call_ops` module (handle call + va-* forms, EH invoke logic + forward decl scan helper) | Medium | Done (initial) | Module exists; lingering unresolved symbol intermittently observed earlier; de-prioritized per direction. |
| 3 | Add `return_ops` module (handle `ret`) | Low | Done | Integrated and dispatch consolidated. |
| 4 | Extract block handling to dedicated `flow_ops` | Low | Done | New `flow_ops` module; locals + lexical scope mgmt; removed inline block code. |
| 5 | Consolidate repeated `builder::State` constructions into shared instance | Low | Done | Introduced single `sharedState` inside dispatcher loop. |
| 6 | Extract / unify value resolution helpers (`ensureSlot`, `getVal`, `evalDefined`) | Medium | In Progress | Not yet moved; candidates for `value_resolver` or methods on `builder::State`. |
| 7 | Optionally extract function definition parsing into `function_builder` | Medium | Pending | Deferred until after resolver extraction. |
| 8 | Add dedicated debug locals emission module (follow-up from flow_ops placeholder) | Low | Planned | Tracked under EDN-0004 but referenced here due to placeholder removal. |

## Acceptance Criteria
- After Stage 1â€“5: No functional regressions; build green; `edn.cpp` dispatcher relies mostly on *_ops modules plus shared state.
- After Stage 6: All ops modules use shared resolution utilities (no duplicated slot load logic) and tests pass.
- After Stage 7: `edn.cpp` contains minimal orchestration code; function parsing logic isolated.
- After Stage 8: Local variable debug info emission handled centrally (pending EDN-0004 coordination).

## Testing Strategy
- Re-run phase-specific and full test suites after each stage (currently build verified; targeted block/local tests still to add).
- Add focused tests if gaps appear (e.g., EH invoke path, variadic call placeholders, nested blocks with locals).

## Notes
- Defer deeper debug info enhancements to `EDN-0004`.
- Avoid intertwining resolver extraction (Stage 5) with call/return extraction to reduce churn.

---
Owner: (unassigned)
Created: 2025-08-21
Related: `EDN-0004` (Debug Info Enhancements)

### Progress Log (2025-08-21)
- Added `flow_ops` module; removed inline `(block ...)` logic.
- Removed invalid debug local emission stub (`emitLocalVar`) and added lexical scope push/pop only.
- Introduced `sharedState` to reduce repeated `builder::State` constructions (core/compare/cast/memory/control/const/phi/exception/coro/call/return now reuse it).
- Updated dispatcher to use `flow_ops` and shared state.
- Confirmed clean build post-refactor (warnings only from LLVM duplicate libs, expected).
- Remaining: unify value resolution helpers (Stage 6), add tests for block locals & nested scopes, revisit earlier intermittent call_ops unresolved symbol when prioritized.
